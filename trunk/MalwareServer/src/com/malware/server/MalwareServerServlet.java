package com.malware.server;
import java.io.IOException;
import java.util.List;

import javax.jdo.PersistenceManager;
import javax.servlet.http.*;

import uk.me.jstott.jcoord.LatLng;

import com.google.gson.Gson;
import com.malware.common.dto.User;
import com.malware.server.maps.GoogleMaps;
import com.malware.server.maps.Route;

@SuppressWarnings("serial")
public class MalwareServerServlet extends HttpServlet {
	public void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
		resp.setContentType("text/plain");
		resp.getWriter().println("Hello, world");
		
		User user = new User("name", 0.1, "promotion", "address", 0.5, 0.6);
		Gson gson = new Gson();
		System.out.println(gson.toJson(user));
		
		LatLng start = new LatLng(34.019968, -118.289988);
		LatLng end = new LatLng(38.019968, -118.289988);
		
		Route route = GoogleMaps.getRoute(start, end);
		
		resp.getWriter().println("Driving Distance between: " + start + " and " + end + " is: " +
								 route.getDistanceInMetres());
		
		resp.getWriter().println("Making this route persistent.");
		
		// Make the Route object persistent.
		PersistenceManager pm = PMF.get().getPersistenceManager();
        try {
        	route.makePersistable();
            pm.makePersistent(route);
        } finally {
            pm.close();
        }
        
        // Displaying all the current persistent routes.
        resp.getWriter().println("Objects in the store: ");
        
        pm = PMF.get().getPersistenceManager();
        String query = "select from " + Route.class.getName();
        List<Route> routes = (List<Route>) pm.newQuery(query).execute();
        if (routes.isEmpty()) {
        	resp.getWriter().println("No objects in store.");	
        } else {
        	int count = routes.size();
        	resp.getWriter().println("Count of objects in store: " + count);
        }   
	}
}
