package com.malware.android;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import com.malware.android.MalwareHttpSender;
import com.malware.android.Notify;
import com.malware.common.dto.Trip;
import com.malware.common.dto.ServerRequest;
import com.malware.common.dto.ServerResponse;
import com.malware.common.dto.ServerRequest.ServerMethod;
import com.malware.common.dto.ServerResponse.ResponseCode;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;
import android.widget.AdapterView.OnItemClickListener;


public class MalwareSearch extends Activity {
	
	Context myContext = this;
	TripAdapter trip_adapter;
	private List<Trip> triplist = null;
	private ProgressDialog m_ProgressDialog = null; 

    private Runnable viewTrips;

    
	public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.malware_search);
       
        Button search = (Button) findViewById(R.id.searchbutton);
        final EditText searchBox = (EditText)findViewById(R.id.searchbox);

        search.setOnClickListener(new View.OnClickListener() {
			

			public void onClick(View view) {
				
				String searchBar = searchBox.getText().toString();		
				
				
				if(searchBar.equalsIgnoreCase(""))
				{
					Notify.notification(myContext,"D'oh!", "Search field is empty!");
				}
				else
				{
					
					ServerRequest s = new ServerRequest();
					s.setServerMethod(ServerMethod.SEARCH_TRIPS);
					s.setSearchKeyword(searchBar);
					final ServerResponse response = MalwareHttpSender.sendData(s);
					if(response.getResponseCode() == ResponseCode.SUCCESS)
					{

						ListView lv = (ListView)findViewById(R.id.listv);
						//lv.setAdapter(new ArrayAdapter<String>(myContext, android.R.layout.simple_list_item_1, COUNTRIES));
						
						triplist = new ArrayList<Trip>();
				        trip_adapter = new TripAdapter(myContext, R.layout.row, triplist);
				        lv.setAdapter(trip_adapter);
						
				        
				        viewTrips = new Runnable(){
				            @Override
				            public void run() {
				            	 try{
				                     triplist=response.getTrips();
				                     Thread.sleep(5000);
				                     Log.i("ARRAY", ""+ triplist.size());
				                   } catch (Exception e) { 
				                     Log.e("BACKGROUND_PROC", e.getMessage());
				                   }
				                   runOnUiThread(returnRes);
				                   
				            }
				        };
				    Thread thread =  new Thread(null, viewTrips, "MagentoBackground");
				        thread.start();
				     m_ProgressDialog = ProgressDialog.show(MalwareSearch.this,    
				              "Please wait...", "Retrieving data ...", true);
				
						
						/*lv.setOnItemClickListener(new OnItemClickListener() {
						public void onItemClick(AdapterView<?> parent, View view,int position, long id) {
						      // When clicked, show a toast with the TextView text
						      Toast.makeText(getApplicationContext(), ((TextView) view).getText(),
						          Toast.LENGTH_SHORT).show();
						}
						
						  });*/
					}
					else
					{
						Log.i("Server Response", "Operation failed");
						Notify.notification(myContext, "D'oh!", response.getReponseMessage());
						
					}
					
				}
					
			} 
			
		});
       
	}
	 private Runnable returnRes = new Runnable() {

         @Override
         public void run() {
             if(triplist != null && triplist.size() > 0){
                 trip_adapter.notifyDataSetChanged();
                 for(int i=0;i<triplist.size();i++)
                 trip_adapter.add(triplist.get(i));
             }
             m_ProgressDialog.dismiss();
             trip_adapter.notifyDataSetChanged();
         }
       };
	
}
        
 