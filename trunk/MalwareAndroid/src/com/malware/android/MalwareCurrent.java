package com.malware.android;

import java.util.List;

import com.malware.common.dto.ServerRequest;
import com.malware.common.dto.ServerResponse;
import com.malware.common.dto.Trip;
import com.malware.common.dto.User;
import com.malware.common.dto.ServerRequest.ServerMethod;
import com.malware.common.dto.ServerResponse.ResponseCode;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.Dialog;
import android.app.ProgressDialog;
import android.app.AlertDialog.Builder;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.view.View;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.ListView;
import android.widget.AdapterView.OnItemClickListener;

public class MalwareCurrent extends Activity 
{
	private ServerResponse response = null;
	private String u = null;
	private List<Trip> triplist = null;
	ProgressDialog dialog = null;
	TripAdapter trip_adapter = null;
	Handler currentHandler = new Handler();
	ListView lv, lv_matches;

	Context myContext;

	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.malware_current);
		myContext = this;

		Bundle b = this.getIntent().getExtras();
		u = b.getString("riderOrDriver");

		Button newCarpool = (Button) findViewById(R.id.malware_current_new);
		newCarpool.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				Intent myIntent = new Intent(myContext, MalwareMaps.class);
				myIntent.putExtra("riderOrDriver", u);
				startActivity(myIntent);
			}
		});


		lv = (ListView)findViewById(R.id.malware_current_list);
		lv_matches = (ListView)findViewById(R.id.malware_matches);

		Thread getCurrentThread = new Thread(new Runnable(){
			@Override
			public void run() {
				ServerRequest s = new ServerRequest();
				User user = new User();
				user.setEmail(MalwareDefaults.loginEmailAddress);
				s.setUser(user);
				if(u.equalsIgnoreCase("rider"))
				{
					s.setServerMethod(ServerMethod.SEARCH_RIDER_TRIPS);	
				}

				if(u.equalsIgnoreCase("driver"))
				{
					s.setServerMethod(ServerMethod.SEARCH_DRIVER_TRIPS);	
				}
				response = MalwareHttpSender.sendData(s);

				currentHandler.post(new Runnable(){
					public void run() {
						if(response.getResponseCode() == ResponseCode.SUCCESS)
						{
							dialog.cancel();
							triplist = response.getTrips();
							trip_adapter = new TripAdapter(myContext, R.layout.row, triplist);
							lv.setAdapter(trip_adapter);
						}
					}
				});
			}

		});
		getCurrentThread.start();
		dialog = ProgressDialog.show(myContext, "", 
				"Getting your information...", true);

		lv.setOnItemClickListener(new OnItemClickListener() {
			@Override
			public void onItemClick(AdapterView<?> a, View v, int position, long id) {

				/*Builder adb=new AlertDialog.Builder(MalwareCurrent.this);
				adb.setTitle("LVSelectedItemExample");
				adb.setMessage("Selected Item is = "+lv.getItemAtPosition(position));
				adb.setPositiveButton("Ok", null);
				adb.show();*/

				Dialog dialog = new Dialog(myContext); 
				dialog.setContentView(R.layout.malware_matches); 
				dialog.setTitle("Matches found!!!"); 
				dialog.setCancelable(true);
				dialog.show();
			}
		});
	}
}