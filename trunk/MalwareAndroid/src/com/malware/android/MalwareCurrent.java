package com.malware.android;

import java.util.List;

import com.malware.common.dto.ServerRequest;
import com.malware.common.dto.ServerResponse;
import com.malware.common.dto.Trip;
import com.malware.common.dto.User;
import com.malware.common.dto.ServerRequest.ServerMethod;
import com.malware.common.dto.ServerResponse.ResponseCode;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.view.View;
import android.widget.Button;
import android.widget.ListView;

public class MalwareCurrent extends Activity 
{
	private ServerResponse response = null;
	private String u = null;
	private List<Trip> triplist = null;
	ProgressDialog dialog = null;
	TripAdapter trip_adapter = null;
	Handler currentHandler = new Handler();
	
	Context myContext;
	
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.malware_current);
		myContext = this;
		
		Bundle b = this.getIntent().getExtras();
		u = b.getString("riderOrDriver");
		
		Button newCarpool = (Button) findViewById(R.id.malware_current_new);
		newCarpool.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				Intent myIntent = new Intent(myContext, MalwareMaps.class);
				startActivity(myIntent);
			}
		});
		
		Thread getCurrentThread = new Thread(new Runnable(){
			@Override
			public void run() {
				ServerRequest s = new ServerRequest();
				User user = new User();
				user.setEmail(MalwareDefaults.loginEmailAddress);
				s.setUser(user);
				if(u.equalsIgnoreCase("rider"))
				{
					s.setServerMethod(ServerMethod.SEARCH_RIDER_TRIPS);	
				}
				
				if(u.equalsIgnoreCase("driver"))
				{
					s.setServerMethod(ServerMethod.SEARCH_DRIVER_TRIPS);	
				}
				response = MalwareHttpSender.sendData(s);
				
				currentHandler.post(new Runnable(){
					public void run() {
						if(response.getResponseCode() == ResponseCode.SUCCESS)
						{
							dialog.cancel();
							ListView lv = (ListView)findViewById(R.id.malware_current_list);
							triplist = response.getTrips();
					        trip_adapter = new TripAdapter(myContext, R.layout.row, triplist);
					        lv.setAdapter(trip_adapter);
						}
					}
				});
			}
			
		});
		getCurrentThread.start();
		dialog = ProgressDialog.show(myContext, "", 
                "Getting your information...", true);
	}
}