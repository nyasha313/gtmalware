package com.malware.android;

import com.malware.common.dto.ServerRequest;
import com.malware.common.dto.ServerResponse;
import com.malware.common.dto.User;
import com.malware.common.dto.ServerRequest.ServerMethod;
import com.malware.common.dto.ServerResponse.ResponseCode;

import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.os.Handler;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;

public class MalwareLogin extends Activity{

	public static final String MYPREFS = "mySharedPreferences";

	Context myContext = this;
	Handler loginHandler = new Handler();
	String userName = null;
	String password = null;
	ServerResponse response = null;
	ProgressDialog dialog = null;
	EditText userNameBox = null;
	EditText passwordBox = null;

	private boolean CheckUserNamePassword(String u, String p)
	{
		ServerRequest s = new ServerRequest();
		User user = new User();
		user.setEmail(u);
		user.setPassword(p);
		s.setUser(user);
		s.setServerMethod(ServerMethod.VERIFY_USER);
		ServerResponse response = MalwareHttpSender.sendData(s);
		return false;
	}

	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.malware_login);
		Button login = (Button) findViewById(R.id.malware_login_login);
		Button exit = (Button) findViewById(R.id.malware_login_exit);
		Button signup = (Button) findViewById(R.id.malware_login_signup);
		userNameBox = (EditText)findViewById(R.id.malware_login_username);
		passwordBox = (EditText)findViewById(R.id.malware_login_password);
		
		loadRememberMe();

		login.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				userName = userNameBox.getText().toString();
				password = passwordBox.getText().toString();
				if((userName.equalsIgnoreCase(""))||(password.equalsIgnoreCase("")))
				{
					dialog.cancel();
					Notify.notification(myContext, "D'oh!", "Enter valid username or password");	
				}
				else
				{
					Thread loginThread = new Thread(new Runnable(){

						@Override
						public void run() {
							ServerRequest s = new ServerRequest();
							User user = new User();
							user.setEmail(userName);
							user.setPassword(password);
							s.setUser(user);
							s.setServerMethod(ServerMethod.VERIFY_USER);
							response = MalwareHttpSender.sendData(s);
							
							loginHandler.post(new Runnable(){
								public void run() {
									if(response.getResponseCode() == ResponseCode.SUCCESS)
									{
										dialog.cancel();
										MalwareDefaults.loginEmailAddress = userName;
										rememberMe();
										Intent myIntent = new Intent(myContext, MalwareRequest.class);
										startActivity(myIntent);
									}
									else
									{
										dialog.cancel();
										Notify.notification(myContext, "D'oh!", response.getReponseMessage());
									}
								}
							});
						}
					});
					loginThread.start();
					dialog = ProgressDialog.show(myContext, "", 
	                        "Logging in. Please wait...", true);

					/*
					MalwareDefaults.loginEmailAddress = userName;
					Intent myIntent = new Intent(view.getContext(), MalwareRequest.class);
					startActivity(myIntent);
					 */
				}
			}
		});

		
		exit.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				Intent myIntent = new Intent(view.getContext(), MalwareExit.class);
				startActivity(myIntent);
			}
		});

		signup.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				Intent myIntent = new Intent(view.getContext(), MalwareSignup.class);
				startActivity(myIntent);
			}
		});

	}
	protected void rememberMe() {
		int mode = Activity.MODE_PRIVATE;
		SharedPreferences mySharedPreferences = getSharedPreferences(MYPREFS,
				mode);

		SharedPreferences.Editor editor = mySharedPreferences.edit();

		editor.putString("username", userName);
		editor.putString("password", password);

		editor.commit();
	}
	
	public void loadRememberMe() {
		int mode = Activity.MODE_PRIVATE;
		SharedPreferences mySharedPreferences = getSharedPreferences(
				"mySharedPreferences", mode);

		userName = mySharedPreferences.getString("username", "");
		password = mySharedPreferences.getString("password", "");

		userNameBox.setText(userName);
		passwordBox.setText(password);
	}
}
