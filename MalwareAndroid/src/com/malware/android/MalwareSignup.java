package com.malware.android;

import com.google.gson.Gson;
import com.malware.common.dto.ServerRequest;
import com.malware.common.dto.ServerResponse;
import com.malware.common.dto.User;
import com.malware.common.dto.ServerRequest.ServerMethod;
import com.malware.common.dto.ServerResponse.ResponseCode;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Spinner;
import android.widget.AdapterView.OnItemSelectedListener;

public class MalwareSignup extends Activity {
	
	private Context myContext = this;
	private String gender;
	
	public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.malware_signup);
        Button register = (Button) findViewById(R.id.malware_signup_register);
        Button back = (Button) findViewById(R.id.malware_signup_back);
        
        final EditText userNameBox = (EditText)findViewById(R.id.malware_signup_user_name);
        final EditText passwordBox = (EditText)findViewById(R.id.malware_signup_password);
        final EditText confirmPassBox = (EditText)findViewById(R.id.malware_signup_confirm_password);
        final EditText firstNameBox = (EditText)findViewById(R.id.malware_signup_first_name);
        final EditText lastNameBox = (EditText)findViewById(R.id.malware_signup_last_name);
        final EditText addressBox = (EditText)findViewById(R.id.malware_signup_address);
        final EditText cityBox = (EditText)findViewById(R.id.malware_signup_city);
        final EditText zipCodeBox = (EditText)findViewById(R.id.malware_signup_zipcode);
        final EditText phoneBox = (EditText)findViewById(R.id.malware_signup_phone);
        
        Spinner gender_spinner = (Spinner) findViewById(R.id.malware_signup_gender);
        ArrayAdapter adapter = ArrayAdapter.createFromResource(
                this, R.array.Gender, android.R.layout.simple_spinner_item);
        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
        gender_spinner.setAdapter(adapter);
        
    	gender_spinner.setOnItemSelectedListener(new OnItemSelectedListener() {

			public void onItemSelected(AdapterView<?> arg0, View arg1, int arg2, long arg3) 
			{
				if(arg2 == 0)
				{
					gender = "Male";
				}
				else
					gender = "Female";
			}

			public void onNothingSelected(AdapterView<?> arg0) {

			}
		});

        
        register.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				
				String userName = userNameBox.getText().toString();
				String password = passwordBox.getText().toString();
				String confirmPass = confirmPassBox.getText().toString();
				String fname = firstNameBox.getText().toString();
				String lname = lastNameBox.getText().toString();
				String address = addressBox.getText().toString();
				String city = cityBox.getText().toString();
				String zip = zipCodeBox.getText().toString();
				String phone = phoneBox.getText().toString();
				
				/* get data here and do sanity checks*/
				if(
						userName.equalsIgnoreCase("")||
						password.equalsIgnoreCase("")||
						confirmPass.equalsIgnoreCase("")||
						fname.equalsIgnoreCase("")||
						lname.equalsIgnoreCase("") ||
						address.equalsIgnoreCase("") ||
						city.equalsIgnoreCase("") ||
						zip.equalsIgnoreCase("") ||
						phone.equalsIgnoreCase(""))
				{
					Notify.notification(myContext,"D'oh!", "One of the required fields is empty!");
				}
				else
				{
					if(password.compareTo(confirmPass) != 0)
					{
						Notify.notification(myContext,"D'oh!", "Passwords don't match!");
					}
					else
					{
						User u = new User(fname, lname, gender, address, city, zip, userName, phone);
						u.setPassword(password);
						ServerRequest s = new ServerRequest();
						s.setServerMethod(ServerMethod.STORE_NEW_USER);
						s.setUser(u);
						ServerResponse response = MalwareHttpSender.sendData(s);
						if(response.getResponseCode() == ResponseCode.SUCCESS)
						{
							Log.i("Server Response", "Operation successful");
							MalwareDefaults.loginEmailAddress = userName;
							Intent myIntent = new Intent(view.getContext(), MalwareFacebookConnect.class);
							startActivity(myIntent);
						}
						else
						{
							Log.i("Server Response", "Operation failed");
						}
					}
        		        			
        		}
			}
		});
        
        back.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				setResult(RESULT_CANCELED);
				finish();
			}
		});
	}
}
